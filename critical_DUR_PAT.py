from osgeo import gdal
import os, glob, os.path
from os.path import *

#### ENTER DIRECTORY LOCATION HERE ###
location = '/models/1%AEP/' # this is critical for the scripts to run, you must put all your files in a folder called files
######################################

def crit_DUR_PAT(directory, filepattern='*.tif'):
    pattern = os.path.join(directory, filepattern)
    directory = glob.glob(pattern) 

    for filename in directory:
        
        ds = gdal.Open(filename)
        
        head, file = os.path.split(filename)
        
        #print (file)
        driver = gdal.GetDriverByName('GTiff')

        band = ds.GetRasterBand(1)
        
        cols = ds.RasterXSize
        rows = ds.RasterYSize
        
        transform = ds.GetGeoTransform()
        
        xOrigin = transform[0]
        yOrigin = transform[3]
        pixelWidth = transform[1]
        pixelHeight = -transform[5]
        
        data = band.ReadAsArray(0, 0, cols, rows)
        
        #list of X,Y coordinates
        points_list = [(306679.877,6187525.723), (305829.954,6188350.062), (305497.573,6187034.980), (304762.441,6186692.149), (304979.435,6186066.239), (306679.387,6186665.085), (306954.652,6187838.069)] 
        
        # the points_list below is a 100m grid of the Wollongong City catchment
        #points_list = [(306597.276,6188804.200),(306697.276,6188804.200),(306797.276,6188804.200),(306897.276,6188804.200),(306997.276,6188804.200),(306197.276,6188704.200),(306297.276,6188704.200),(306397.276,6188704.200),(306497.276,6188704.200),(306597.276,6188704.200),(306697.276,6188704.200),(306797.276,6188704.200),(306897.276,6188704.200),(306997.276,6188704.200),(307097.276,6188704.200),(304497.276,6188604.200),(304597.276,6188604.200),(305397.276,6188604.200),(305497.276,6188604.200),(305597.276,6188604.200),(305697.276,6188604.200),(305797.276,6188604.200),(305997.276,6188604.200),(306097.276,6188604.200),(306197.276,6188604.200),(306297.276,6188604.200),(306397.276,6188604.200),(306497.276,6188604.200),(306597.276,6188604.200),(306697.276,6188604.200),(306797.276,6188604.200),(306897.276,6188604.200),(306997.276,6188604.200),(307097.276,6188604.200),(307197.276,6188604.200),(304497.276,6188504.200),(304597.276,6188504.200),(304697.276,6188504.200),(304797.276,6188504.200),(304897.276,6188504.200),(304997.276,6188504.200),(305097.276,6188504.200),(305197.276,6188504.200),(305297.276,6188504.200),(305397.276,6188504.200),(305497.276,6188504.200),(305597.276,6188504.200),(305697.276,6188504.200),(305797.276,6188504.200),(305897.276,6188504.200),(305997.276,6188504.200),(306097.276,6188504.200),(306197.276,6188504.200),(306297.276,6188504.200),(306397.276,6188504.200),(306497.276,6188504.200),(306597.276,6188504.200),(306697.276,6188504.200),(306797.276,6188504.200),(306897.276,6188504.200),(306997.276,6188504.200),(307097.276,6188504.200),(307197.276,6188504.200),(307297.276,6188504.200),(304497.276,6188404.200),(304597.276,6188404.200),(304697.276,6188404.200),(304797.276,6188404.200),(304897.276,6188404.200),(304997.276,6188404.200),(305097.276,6188404.200),(305197.276,6188404.200),(305297.276,6188404.200),(305397.276,6188404.200),(305497.276,6188404.200),(305597.276,6188404.200),(305697.276,6188404.200),(305797.276,6188404.200),(305897.276,6188404.200),(305997.276,6188404.200),(306097.276,6188404.200),(306197.276,6188404.200),(306297.276,6188404.200),(306397.276,6188404.200),(306497.276,6188404.200),(306597.276,6188404.200),(306697.276,6188404.200),(306797.276,6188404.200),(306897.276,6188404.200),(306997.276,6188404.200),(307097.276,6188404.200),(307197.276,6188404.200),(307297.276,6188404.200),(304497.276,6188304.200),(304597.276,6188304.200),(304697.276,6188304.200),(304797.276,6188304.200),(304897.276,6188304.200),(304997.276,6188304.200),(305097.276,6188304.200),(305197.276,6188304.200),(305297.276,6188304.200),(305397.276,6188304.200),(305497.276,6188304.200),(305597.276,6188304.200),(305697.276,6188304.200),(305797.276,6188304.200),(305897.276,6188304.200),(305997.276,6188304.200),(306097.276,6188304.200),(306197.276,6188304.200),(306297.276,6188304.200),(306397.276,6188304.200),(306497.276,6188304.200),(306597.276,6188304.200),(306697.276,6188304.200),(306797.276,6188304.200),(306897.276,6188304.200),(306997.276,6188304.200),(307097.276,6188304.200),(307197.276,6188304.200),(304597.276,6188204.200),(304697.276,6188204.200),(304797.276,6188204.200),(304897.276,6188204.200),(304997.276,6188204.200),(305097.276,6188204.200),(305197.276,6188204.200),(305297.276,6188204.200),(305397.276,6188204.200),(305497.276,6188204.200),(305597.276,6188204.200),(305697.276,6188204.200),(305797.276,6188204.200),(305897.276,6188204.200),(305997.276,6188204.200),(306097.276,6188204.200),(306197.276,6188204.200),(306297.276,6188204.200),(306397.276,6188204.200),(306497.276,6188204.200),(306597.276,6188204.200),(306697.276,6188204.200),(306797.276,6188204.200),(306897.276,6188204.200),(306997.276,6188204.200),(307097.276,6188204.200),(307197.276,6188204.200),(304597.276,6188104.200),(304697.276,6188104.200),(304797.276,6188104.200),(304897.276,6188104.200),(304997.276,6188104.200),(305097.276,6188104.200),(305197.276,6188104.200),(305297.276,6188104.200),(305397.276,6188104.200),(305497.276,6188104.200),(305597.276,6188104.200),(305697.276,6188104.200),(305797.276,6188104.200),(305897.276,6188104.200),(305997.276,6188104.200),(306097.276,6188104.200),(306197.276,6188104.200),(306297.276,6188104.200),(306397.276,6188104.200),(306497.276,6188104.200),(306597.276,6188104.200),(306697.276,6188104.200),(306797.276,6188104.200),(306897.276,6188104.200),(306997.276,6188104.200),(307097.276,6188104.200),(307197.276,6188104.200),(304697.276,6188004.200),(304797.276,6188004.200),(304897.276,6188004.200),(304997.276,6188004.200),(305097.276,6188004.200),(305197.276,6188004.200),(305297.276,6188004.200),(305397.276,6188004.200),(305497.276,6188004.200),(305597.276,6188004.200),(305697.276,6188004.200),(305797.276,6188004.200),(305897.276,6188004.200),(305997.276,6188004.200),(306097.276,6188004.200),(306197.276,6188004.200),(306297.276,6188004.200),(306397.276,6188004.200),(306497.276,6188004.200),(306597.276,6188004.200),(306697.276,6188004.200),(306797.276,6188004.200),(306897.276,6188004.200),(306997.276,6188004.200),(307097.276,6188004.200),(305197.276,6187904.200),(305297.276,6187904.200),(305397.276,6187904.200),(305497.276,6187904.200),(305597.276,6187904.200),(305697.276,6187904.200),(305797.276,6187904.200),(305897.276,6187904.200),(305997.276,6187904.200),(306097.276,6187904.200),(306197.276,6187904.200),(306297.276,6187904.200),(306397.276,6187904.200),(306497.276,6187904.200),(306597.276,6187904.200),(306697.276,6187904.200),(306797.276,6187904.200),(306897.276,6187904.200),(306997.276,6187904.200),(307097.276,6187904.200),(305097.276,6187804.200),(305197.276,6187804.200),(305297.276,6187804.200),(305397.276,6187804.200),(305497.276,6187804.200),(305597.276,6187804.200),(305697.276,6187804.200),(305797.276,6187804.200),(305897.276,6187804.200),(305997.276,6187804.200),(306097.276,6187804.200),(306197.276,6187804.200),(306297.276,6187804.200),(306397.276,6187804.200),(306497.276,6187804.200),(306597.276,6187804.200),(306697.276,6187804.200),(306797.276,6187804.200),(306897.276,6187804.200),(306997.276,6187804.200),(307097.276,6187804.200),(304997.276,6187704.200),(305097.276,6187704.200),(305197.276,6187704.200),(305297.276,6187704.200),(305397.276,6187704.200),(305497.276,6187704.200),(305597.276,6187704.200),(305697.276,6187704.200),(305797.276,6187704.200),(305897.276,6187704.200),(305997.276,6187704.200),(306097.276,6187704.200),(306197.276,6187704.200),(306297.276,6187704.200),(306397.276,6187704.200),(306497.276,6187704.200),(306597.276,6187704.200),(306697.276,6187704.200),(306797.276,6187704.200),(306897.276,6187704.200),(306997.276,6187704.200),(307097.276,6187704.200),(304897.276,6187604.200),(304997.276,6187604.200),(305097.276,6187604.200),(305197.276,6187604.200),(305297.276,6187604.200),(305397.276,6187604.200),(305497.276,6187604.200),(305597.276,6187604.200),(305697.276,6187604.200),(305797.276,6187604.200),(305897.276,6187604.200),(305997.276,6187604.200),(306097.276,6187604.200),(306197.276,6187604.200),(306297.276,6187604.200),(306397.276,6187604.200),(306497.276,6187604.200),(306597.276,6187604.200),(306697.276,6187604.200),(306797.276,6187604.200),(306897.276,6187604.200),(306997.276,6187604.200),(307097.276,6187604.200),(304897.276,6187504.200),(304997.276,6187504.200),(305097.276,6187504.200),(305197.276,6187504.200),(305297.276,6187504.200),(305397.276,6187504.200),(305497.276,6187504.200),(305597.276,6187504.200),(305697.276,6187504.200),(305797.276,6187504.200),(305897.276,6187504.200),(305997.276,6187504.200),(306097.276,6187504.200),(306197.276,6187504.200),(306297.276,6187504.200),(306397.276,6187504.200),(306497.276,6187504.200),(306597.276,6187504.200),(306697.276,6187504.200),(306797.276,6187504.200),(306897.276,6187504.200),(306997.276,6187504.200),(307097.276,6187504.200),(304797.276,6187404.200),(304897.276,6187404.200),(304997.276,6187404.200),(305097.276,6187404.200),(305197.276,6187404.200),(305297.276,6187404.200),(305397.276,6187404.200),(305497.276,6187404.200),(305597.276,6187404.200),(305697.276,6187404.200),(305797.276,6187404.200),(305897.276,6187404.200),(305997.276,6187404.200),(306097.276,6187404.200),(306197.276,6187404.200),(306297.276,6187404.200),(306397.276,6187404.200),(306497.276,6187404.200),(306597.276,6187404.200),(306697.276,6187404.200),(306797.276,6187404.200),(306897.276,6187404.200),(306997.276,6187404.200),(307097.276,6187404.200),(304797.276,6187304.200),(304897.276,6187304.200),(304997.276,6187304.200),(305097.276,6187304.200),(305197.276,6187304.200),(305297.276,6187304.200),(305397.276,6187304.200),(305497.276,6187304.200),(305597.276,6187304.200),(305697.276,6187304.200),(305797.276,6187304.200),(305897.276,6187304.200),(305997.276,6187304.200),(306097.276,6187304.200),(306197.276,6187304.200),(306297.276,6187304.200),(306397.276,6187304.200),(306497.276,6187304.200),(306597.276,6187304.200),(306697.276,6187304.200),(306797.276,6187304.200),(306897.276,6187304.200),(306997.276,6187304.200),(304797.276,6187204.200),(304897.276,6187204.200),(304997.276,6187204.200),(305097.276,6187204.200),(305197.276,6187204.200),(305297.276,6187204.200),(305397.276,6187204.200),(305497.276,6187204.200),(305597.276,6187204.200),(305697.276,6187204.200),(305797.276,6187204.200),(305897.276,6187204.200),(305997.276,6187204.200),(306097.276,6187204.200),(306197.276,6187204.200),(306297.276,6187204.200),(306397.276,6187204.200),(306497.276,6187204.200),(306597.276,6187204.200),(306697.276,6187204.200),(306797.276,6187204.200),(306897.276,6187204.200),(306997.276,6187204.200),(304797.276,6187104.200),(304897.276,6187104.200),(304997.276,6187104.200),(305097.276,6187104.200),(305197.276,6187104.200),(305297.276,6187104.200),(305397.276,6187104.200),(305497.276,6187104.200),(305597.276,6187104.200),(305697.276,6187104.200),(305797.276,6187104.200),(305897.276,6187104.200),(305997.276,6187104.200),(306097.276,6187104.200),(306197.276,6187104.200),(306297.276,6187104.200),(306397.276,6187104.200),(306497.276,6187104.200),(306597.276,6187104.200),(306697.276,6187104.200),(306797.276,6187104.200),(306897.276,6187104.200),(306997.276,6187104.200),(304697.276,6187004.200),(304797.276,6187004.200),(304897.276,6187004.200),(304997.276,6187004.200),(305097.276,6187004.200),(305197.276,6187004.200),(305297.276,6187004.200),(305397.276,6187004.200),(305497.276,6187004.200),(305597.276,6187004.200),(305697.276,6187004.200),(305797.276,6187004.200),(305897.276,6187004.200),(305997.276,6187004.200),(306097.276,6187004.200),(306197.276,6187004.200),(306297.276,6187004.200),(306397.276,6187004.200),(306497.276,6187004.200),(306597.276,6187004.200),(306697.276,6187004.200),(306797.276,6187004.200),(306897.276,6187004.200),(306997.276,6187004.200),(304597.276,6186904.200),(304697.276,6186904.200),(304797.276,6186904.200),(304897.276,6186904.200),(304997.276,6186904.200),(305097.276,6186904.200),(305197.276,6186904.200),(305297.276,6186904.200),(305397.276,6186904.200),(305497.276,6186904.200),(305597.276,6186904.200),(305697.276,6186904.200),(305797.276,6186904.200),(305897.276,6186904.200),(305997.276,6186904.200),(306097.276,6186904.200),(306197.276,6186904.200),(306297.276,6186904.200),(306397.276,6186904.200),(306497.276,6186904.200),(306597.276,6186904.200),(306697.276,6186904.200),(306797.276,6186904.200),(306897.276,6186904.200),(306997.276,6186904.200),(304497.276,6186804.200),(304597.276,6186804.200),(304697.276,6186804.200),(304797.276,6186804.200),(304897.276,6186804.200),(304997.276,6186804.200),(305097.276,6186804.200),(305197.276,6186804.200),(305297.276,6186804.200),(305397.276,6186804.200),(305497.276,6186804.200),(305597.276,6186804.200),(305697.276,6186804.200),(305797.276,6186804.200),(305897.276,6186804.200),(305997.276,6186804.200),(306097.276,6186804.200),(306197.276,6186804.200),(306297.276,6186804.200),(306397.276,6186804.200),(306497.276,6186804.200),(306597.276,6186804.200),(306697.276,6186804.200),(306797.276,6186804.200),(306897.276,6186804.200),(306997.276,6186804.200),(304397.276,6186704.200),(304497.276,6186704.200),(304597.276,6186704.200),(304697.276,6186704.200),(304797.276,6186704.200),(304897.276,6186704.200),(304997.276,6186704.200),(305097.276,6186704.200),(305197.276,6186704.200),(305297.276,6186704.200),(305397.276,6186704.200),(305497.276,6186704.200),(305597.276,6186704.200),(305697.276,6186704.200),(305797.276,6186704.200),(305897.276,6186704.200),(305997.276,6186704.200),(306097.276,6186704.200),(306197.276,6186704.200),(306297.276,6186704.200),(306397.276,6186704.200),(306497.276,6186704.200),(306597.276,6186704.200),(306697.276,6186704.200),(306797.276,6186704.200),(306897.276,6186704.200),(304397.276,6186604.200),(304497.276,6186604.200),(304597.276,6186604.200),(304697.276,6186604.200),(304797.276,6186604.200),(304897.276,6186604.200),(304997.276,6186604.200),(305097.276,6186604.200),(305197.276,6186604.200),(305297.276,6186604.200),(305397.276,6186604.200),(305497.276,6186604.200),(305597.276,6186604.200),(305697.276,6186604.200),(305797.276,6186604.200),(305897.276,6186604.200),(305997.276,6186604.200),(306097.276,6186604.200),(306197.276,6186604.200),(306297.276,6186604.200),(306397.276,6186604.200),(306497.276,6186604.200),(306597.276,6186604.200),(306697.276,6186604.200),(306797.276,6186604.200),(306897.276,6186604.200),(304397.276,6186504.200),(304497.276,6186504.200),(304597.276,6186504.200),(304697.276,6186504.200),(304797.276,6186504.200),(304897.276,6186504.200),(304997.276,6186504.200),(305097.276,6186504.200),(305197.276,6186504.200),(305297.276,6186504.200),(305397.276,6186504.200),(305497.276,6186504.200),(305597.276,6186504.200),(305697.276,6186504.200),(305797.276,6186504.200),(305897.276,6186504.200),(305997.276,6186504.200),(306097.276,6186504.200),(306197.276,6186504.200),(306297.276,6186504.200),(306397.276,6186504.200),(306497.276,6186504.200),(306597.276,6186504.200),(306697.276,6186504.200),(306797.276,6186504.200),(306897.276,6186504.200),(304397.276,6186404.200),(304497.276,6186404.200),(304597.276,6186404.200),(304697.276,6186404.200),(304797.276,6186404.200),(304897.276,6186404.200),(304997.276,6186404.200),(305097.276,6186404.200),(305197.276,6186404.200),(305297.276,6186404.200),(305397.276,6186404.200),(305497.276,6186404.200),(305597.276,6186404.200),(305697.276,6186404.200),(305897.276,6186404.200),(305997.276,6186404.200),(306097.276,6186404.200),(306197.276,6186404.200),(306297.276,6186404.200),(306397.276,6186404.200),(306497.276,6186404.200),(306597.276,6186404.200),(306697.276,6186404.200),(306797.276,6186404.200),(306897.276,6186404.200),(304397.276,6186304.200),(304497.276,6186304.200),(304597.276,6186304.200),(304697.276,6186304.200),(304797.276,6186304.200),(304897.276,6186304.200),(304997.276,6186304.200),(305097.276,6186304.200),(305197.276,6186304.200),(305297.276,6186304.200),(305397.276,6186304.200),(305497.276,6186304.200),(305597.276,6186304.200),(305697.276,6186304.200),(305897.276,6186304.200),(305997.276,6186304.200),(306097.276,6186304.200),(306197.276,6186304.200),(306297.276,6186304.200),(306397.276,6186304.200),(306497.276,6186304.200),(306597.276,6186304.200),(306697.276,6186304.200),(306797.276,6186304.200),(306897.276,6186304.200),(306997.276,6186304.200),(304397.276,6186204.200),(304497.276,6186204.200),(304597.276,6186204.200),(304697.276,6186204.200),(304797.276,6186204.200),(304897.276,6186204.200),(304997.276,6186204.200),(305097.276,6186204.200),(305197.276,6186204.200),(305297.276,6186204.200),(305397.276,6186204.200),(305497.276,6186204.200),(305597.276,6186204.200),(305997.276,6186204.200),(306097.276,6186204.200),(306197.276,6186204.200),(306297.276,6186204.200),(306397.276,6186204.200),(306497.276,6186204.200),(306597.276,6186204.200),(306697.276,6186204.200),(306797.276,6186204.200),(306897.276,6186204.200),(306997.276,6186204.200),(304397.276,6186104.200),(304497.276,6186104.200),(304597.276,6186104.200),(304697.276,6186104.200),(304797.276,6186104.200),(304897.276,6186104.200),(304997.276,6186104.200),(305097.276,6186104.200),(305197.276,6186104.200),(305297.276,6186104.200),(305397.276,6186104.200),(305497.276,6186104.200),(306197.276,6186104.200),(306297.276,6186104.200),(306397.276,6186104.200),(306497.276,6186104.200),(306597.276,6186104.200),(306697.276,6186104.200),(306797.276,6186104.200),(306897.276,6186104.200),(306997.276,6186104.200),(304397.276,6186004.200),(304497.276,6186004.200),(304597.276,6186004.200),(304697.276,6186004.200),(304797.276,6186004.200),(304897.276,6186004.200),(304997.276,6186004.200),(305097.276,6186004.200),(305197.276,6186004.200),(305297.276,6186004.200),(305397.276,6186004.200),(305497.276,6186004.200),(306397.276,6186004.200),(306497.276,6186004.200),(306597.276,6186004.200),(306697.276,6186004.200),(306797.276,6186004.200),(306897.276,6186004.200),(306997.276,6186004.200),(304397.276,6185904.200),(304497.276,6185904.200),(304597.276,6185904.200),(304697.276,6185904.200),(304797.276,6185904.200),(304897.276,6185904.200),(304997.276,6185904.200),(305097.276,6185904.200),(305197.276,6185904.200),(305297.276,6185904.200),(305397.276,6185904.200),(305497.276,6185904.200),(306497.276,6185904.200),(306597.276,6185904.200),(306697.276,6185904.200),(306797.276,6185904.200),(306897.276,6185904.200),(306997.276,6185904.200),(304697.276,6185804.200),(304797.276,6185804.200),(304897.276,6185804.200),(304997.276,6185804.200),(305097.276,6185804.200),(305197.276,6185804.200),(305297.276,6185804.200)]
       
        print(points_list)
        for point in points_list:

            col = int((point[0] - xOrigin) / pixelWidth)
            row = int((yOrigin - point[1]) / pixelHeight)
            X = file[0:-4]
            Y = data[row][col]
            print (X, Y)

            ############################################################################
            # below was written by Ole Neilsen on 9 May 2021
            ############################################################################
            
            # Sort by depth (Schwartzian Transform)
            Y = [(d[1], d[0]) for d in X]  # Swap order, making depth the first column
            Y.sort()

            # Calculate average
            sum = 0
            for y in Y:
                sum += y[0]
                print('Element:', y)
            avg = sum/len(Y)
            print('Average is', avg)
            print()
            
            # Now find element immediately greater than average
            i = 0
            y = Y[0][0] 
            while(y <= avg):
                i += 1
                y = Y[i][0]
            depth = Y[i][0]
            filename = Y[i][1]
            
            print('Found filename: ', Y[i][1])
            print('Value: ', Y[i][0])
            print('X,Y: ',point)
            
            # then report the maximum of this list
            
            # write critical storms for each location to a file
            outname = str(storm)+'%AEP_critical_'+quantity
            f = open(outname, 'w')
            f.write('X,Y,critical_DUR/PAT,%s' % quantity)
            f.write('%f,%s,%f\n' % point, Y[i][1], Y[i][0])
            f.close()
            ############################################################################



# enter the data directory where the model runs are located

data_directory = expanduser("~")+location
#print (data_directory)
storms = [1]#,2,5,10,20] # 1=1%AEP, 2=2%AEP etc
durations = [10,15,20,25,30,45,60,90,120,180,270,360,540,720,1080,1440,1800,2160,2880,4320] # do not touch these as they are the standard ARR2019 durations
quantities = ['WL']#,'D','V','VD'] # but we probably are only interested in WL only which dur/pat is critical for max water level

for storm in storms:
	for duration in durations:
		for quantity in quantities:
			event = str(storm)+'%AEP'+str(duration)+'m'
			try:
				fromdir = data_directory+event+'/'+quantity
				#print (fromdir)
				check_polys = crit_DUR_PAT(fromdir)
			except:
				#print (event+' does not exist')
				pass
